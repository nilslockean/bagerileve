---
import Layout from "../../layouts/Layout.astro";
import { getEntry, getCollection } from "astro:content";
import ProductDetail from "@components/ProductDetail/index.astro";
import { sanityAPI } from "@lib/sanityAPI";
import {
  PICKUP_DATE_MIN_OFFSET,
  PICKUP_DATE_MAX_OFFSET,
} from "astro:env/server";
import { getDateString, addDays } from "@lib/dateUtils";

export async function getStaticPaths() {
  const products = await getCollection("products");

  return products.map(({ data: { id } }) => ({
    params: {
      id,
    },
  }));
}

const { id = "" } = Astro.params;
const entry = await getEntry("products", id);

if (!entry) {
  return Astro.rewrite("/404");
}

const pickupDateMin = addDays(PICKUP_DATE_MIN_OFFSET);
const pickupDateMax = addDays(PICKUP_DATE_MAX_OFFSET);

const defaultPickupDates = await sanityAPI.getOpenDaysInRange(
  getDateString(pickupDateMin),
  getDateString(pickupDateMax)
);

const availablePickupDates = entry.data.pickupDates?.length
  ? entry.data.pickupDates
  : defaultPickupDates;
---

<Layout
  title={entry.data.title}
  metaDescription="Beställ dina fredagsmunkar i förväg och hämta enkelt upp vid vald tid."
>
  <ProductDetail product={entry.data} {availablePickupDates} />
</Layout>
