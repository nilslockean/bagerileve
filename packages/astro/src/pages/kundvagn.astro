---
import Layout from "../layouts/Layout.astro";
import { getEntry } from "astro:content";
import Cart from "@components/Cart/index.astro";
import { sanityAPI } from "@lib/sanityAPI";
import {
  PICKUP_DATE_MIN_OFFSET,
  PICKUP_DATE_MAX_OFFSET,
} from "astro:env/server";
import { getDateString, addDays } from "@lib/dateUtils";
import { getCart, getCartTotal } from "@lib/cart";
import { ENABLE_STOREFRONT } from "astro:env/server";

export const prerender = false;

if (!ENABLE_STOREFRONT) {
  return Astro.rewrite("/404");
}

const cart = getCart(Astro.cookies);
const cartContents = await Promise.all(
  cart.items.map(async (item) => {
    const entry = await getEntry("products", item.productId);
    if (!entry) {
      throw `Product ${item.productId} not found`;
    }

    return {
      ...item,
      product: entry.data,
    };
  })
);
const cartTotal = getCartTotal(cart);
const pickupDateMin = addDays(PICKUP_DATE_MIN_OFFSET);
const pickupDateMax = addDays(PICKUP_DATE_MAX_OFFSET);

const defaultPickupDates = await sanityAPI.getOpenDaysInRange(
  getDateString(pickupDateMin),
  getDateString(pickupDateMax)
);

const availablePickupDates = defaultPickupDates;

// const availablePickupDates = entry.data.pickupDates?.length
//   ? entry.data.pickupDates.filter((dateStr) => isDateInFuture(dateStr))
//   : defaultPickupDates;
---

<Layout
  title="Slutför din beställning"
  metaDescription="Slutför din beställning"
>
  <Cart {availablePickupDates} contents={cartContents} total={cartTotal} />
</Layout>
